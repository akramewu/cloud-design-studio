<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS Architecture Design Studio - Powered Professional Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Amazon Ember', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #232f3e 0%, #1a242f 100%);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            background: #232f3e;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #ff9900;
        }

        .header h1 {
            color: #ff9900;
            margin-bottom: 5px;
            font-size: 26px;
        }

        .header .tagline {
            color: #3498db;
            font-size: 13px;
            font-weight: bold;
        }

        .container {
            display: grid;
            grid-template-columns: 250px 1fr 400px;
            gap: 20px;
            max-width: 1900px;
            margin: 0 auto;
            height: calc(100vh - 140px);
        }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 20px;
            backdrop-filter: blur(10px);
            overflow-y: auto;
        }

        .panel h2 {
            color: #ff9900;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #ff9900;
            padding-bottom: 8px;
            position: sticky;
            top: 0;
            background: rgba(35, 47, 62, 0.95);
            z-index: 10;
        }

        .service-category {
            margin-bottom: 20px;
        }

        .category-title {
            color: #3498db;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 8px;
            padding: 5px;
            background: rgba(52, 152, 219, 0.2);
            border-radius: 4px;
        }

        .service-item {
            background: rgba(255, 153, 0, 0.1);
            border: 1px solid #ff9900;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: grab;
            transition: all 0.3s;
            font-size: 13px;
        }

        .service-item:hover {
            background: rgba(255, 153, 0, 0.2);
            transform: translateX(5px);
        }

        .service-icon {
            width: 24px;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
            font-size: 18px;
        }

        .workspace-container {
            position: relative;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            overflow: hidden;
        }

        .controls {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .btn {
            background: #ff9900;
            color: #232f3e;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 12px;
        }

        .btn:hover {
            background: #ec7211;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #3498db;
        }

        .btn-success {
            background: #2ecc71;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-code {
            background: #9b59b6;
        }

        .smart-input-container {
            background: rgba(52, 152, 219, 0.1);
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .smart-input-label {
            color: #3498db;
            font-weight: bold;
            margin-bottom: 6px;
            font-size: 13px;
        }

        .smart-input-row {
            display: flex;
            gap: 8px;
        }

        #smart-input {
            flex: 1;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #3498db;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 13px;
        }

        #canvas {
            width: 100%;
            height: 100%;
            position: relative;
            min-height: 1200px;
            min-width: 1400px;
            background: 
                linear-gradient(rgba(52, 152, 219, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(52, 152, 219, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
        }

        .architecture-element {
            position: absolute;
            min-width: 100px;
            padding: 12px;
            border-radius: 8px;
            cursor: move;
            user-select: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .element-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .element-title {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: bold;
            font-size: 13px;
            flex-wrap: wrap;
        }

        .element-name-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 11px;
            width: 100px;
        }

        .element-controls {
            display: flex;
            gap: 4px;
        }

        .element-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .element-content {
            min-height: 30px;
            font-size: 11px;
            color: #aaa;
        }

        .element-region {
            background: rgba(52, 152, 219, 0.1);
            border: 3px solid #3498db;
        }

        .element-vpc {
            background: rgba(39, 174, 96, 0.1);
            border: 2px solid #27ae60;
        }

        .element-subnet-public {
            background: rgba(46, 204, 113, 0.1);
            border: 2px dashed #2ecc71;
        }

        .element-subnet-private {
            background: rgba(231, 76, 60, 0.1);
            border: 2px dashed #e74c3c;
        }

        .element-service {
            background: rgba(255, 153, 0, 0.15);
            border: 2px solid #ff9900;
        }

        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ff9900;
            border: 1px solid white;
            border-radius: 50%;
            cursor: nwse-resize;
            right: -5px;
            bottom: -5px;
        }

        .empty-state {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #666;
            pointer-events: none;
        }

        .stats-bar {
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid #3498db;
            border-radius: 6px;
            padding: 6px 12px;
            margin-bottom: 8px;
            font-size: 11px;
            display: flex;
            justify-content: space-around;
            gap: 8px;
        }

        .stat-item {
            color: #3498db;
            font-weight: bold;
        }

        .validation-result {
            background: rgba(46, 204, 113, 0.1);
            border-left: 4px solid #2ecc71;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            line-height: 1.6;
            font-size: 13px;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #ff9900;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .example-chips {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 6px;
        }

        .chip {
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid #3498db;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 10px;
            cursor: pointer;
        }

        .chip:hover {
            background: rgba(52, 152, 219, 0.4);
        }

        .info-badge {
            background: rgba(52, 152, 219, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            margin-left: 4px;
        }

        svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            background: #232f3e;
            margin: 5% auto;
            padding: 20px;
            border: 2px solid #ff9900;
            border-radius: 8px;
            width: 80%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ff9900;
        }

        .modal-close {
            color: #ff9900;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .code-block {
            background: #1a1a1a;
            border: 1px solid #3498db;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            overflow-x: auto;
        }

        .code-block pre {
            margin: 0;
            color: #2ecc71;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }

        .code-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .code-tab {
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid #3498db;
            padding: 8px 16px;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            font-weight: bold;
        }

        .code-tab.active {
            background: #3498db;
        }

        .toggle-container {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
            background: rgba(255,255,255,0.05);
            padding: 8px;
            border-radius: 6px;
        }

        .toggle-btn {
            background: rgba(52, 152, 219, 0.3);
            border: 1px solid #3498db;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .toggle-btn.active {
            background: #3498db;
            font-weight: bold;
        }

        .offline-badge {
            background: #2ecc71;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üèóÔ∏è AWS Architecture Design Studio - Powered Professional Tool</h1>
        <p class="tagline">‚ú® Type services ‚Üí Auto-design ‚Üí Validate ‚Üí Export to IaC | Built by Akramul</p>
    </div>

    <div class="container">
        <div class="panel">
            <h2>AWS Services</h2>
            <div id="services-list"></div>
        </div>

        <div class="workspace-container">
            <div class="controls">
                <button class="btn btn-success" onclick="generateFullDesign()">ü§ñ AI: Generate Full Architecture</button>
                <button class="btn" onclick="validateArchitecture()">‚úì Validate Design</button>
                <button class="btn btn-secondary" onclick="autoConnectServices()">üîó Auto-Connect Flow</button>
                <button class="btn btn-code" onclick="exportToCode()">üíª Export to IaC</button>
                <button class="btn btn-danger" onclick="clearArchitecture()">üóëÔ∏è Clear</button>
            </div>

            <div class="smart-input-container">
                <div class="smart-input-label">üß† Type services to auto-design (press Enter):</div>
                <div class="smart-input-row">
                    <input type="text" id="smart-input" placeholder="e.g., region vpc igw alb 2 ec2 rds" 
                        onkeypress="if(event.key === 'Enter') autoDesign()">
                    <button class="btn btn-success" onclick="autoDesign()">üöÄ Auto-Design</button>
                </div>
                <div class="example-chips">
                    <div class="chip" onclick="setExample('region vpc igw alb 2 ec2 rds')">3-Tier Web App</div>
                    <div class="chip" onclick="setExample('region vpc 2 az nat alb asg rds s3')">HA Production</div>
                    <div class="chip" onclick="setExample('vpc lambda dynamodb api gateway')">Serverless API</div>
                </div>
            </div>

            <div class="toggle-container">
                <span style="font-size: 12px; color: #3498db; font-weight: bold;">AI Mode:</span>
                <button class="toggle-btn active" onclick="setMode('offline')" id="offline-btn">Offline (Smart) <span class="offline-badge">Works 100%</span></button>
                <button class="toggle-btn" onclick="setMode('online')" id="online-btn">Gemini API (Optional)</button>
            </div>

            <div class="stats-bar">
                <span class="stat-item">Elements: <span id="element-count">0</span></span>
                <span class="stat-item">Connections: <span id="connection-count">0</span></span>
                <span class="stat-item">Auto-Fixes: <span id="correction-count">0</span></span>
            </div>

            <div style="display: flex; gap: 10px; padding: 8px 15px; background: rgba(41, 128, 185, 0.08); font-size: 11px; align-items: center; border-top: 1px solid rgba(52, 152, 219, 0.2);">
                <div style="font-weight: 600; color: #2c3e50;">Flow Legend:</div>
                <div style="display: flex; align-items: center; gap: 4px;">
                    <div style="width: 25px; height: 3px; background: #2ecc71;"></div>
                    <span style="color: #2ecc71;">‚óè</span>
                    <span>Inbound</span>
                </div>
                <div style="display: flex; align-items: center; gap: 4px;">
                    <div style="width: 25px; height: 3px; background: #3498db;"></div>
                    <span style="color: #3498db;">‚óè</span>
                    <span>Balance</span>
                </div>
                <div style="display: flex; align-items: center; gap: 4px;">
                    <div style="width: 25px; height: 3px; background: #9b59b6;"></div>
                    <span style="color: #9b59b6;">‚óè</span>
                    <span>Database</span>
                </div>
                <div style="display: flex; align-items: center; gap: 4px;">
                    <div style="width: 25px; height: 3px; background: #e67e22;"></div>
                    <span style="color: #e67e22;">‚óè</span>
                    <span>Updates</span>
                </div>
                <div style="display: flex; align-items: center; gap: 4px;">
                    <div style="width: 25px; height: 3px; background: #e74c3c;"></div>
                    <span style="color: #e74c3c;">‚óè</span>
                    <span>Exit</span>
                </div>
            </div>

            <div style="position: relative; height: calc(100% - 200px); overflow: auto;">
                <svg id="connections-svg">
                    <defs>
                        <!-- Green arrow for inbound traffic -->
                        <marker id="arrowhead-2ecc71" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                            <polygon points="0 0, 10 3, 0 6" fill="#2ecc71" />
                        </marker>
                        <!-- Blue arrow for load balancing -->
                        <marker id="arrowhead-3498db" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                            <polygon points="0 0, 10 3, 0 6" fill="#3498db" />
                        </marker>
                        <!-- Purple arrow for database -->
                        <marker id="arrowhead-9b59b6" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                            <polygon points="0 0, 10 3, 0 6" fill="#9b59b6" />
                        </marker>
                        <!-- Orange arrow for outbound -->
                        <marker id="arrowhead-e67e22" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                            <polygon points="0 0, 10 3, 0 6" fill="#e67e22" />
                        </marker>
                        <!-- Red arrow for exit -->
                        <marker id="arrowhead-e74c3c" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                            <polygon points="0 0, 10 3, 0 6" fill="#e74c3c" />
                        </marker>
                    </defs>
                </svg>
                <div id="canvas">
                    <div class="empty-state">
                        <h3>üß† Intelligent Auto-Design</h3>
                        <p>Type: <strong>region vpc igw alb 2 ec2 rds</strong></p>
                        <p style="margin-top: 8px; font-size: 12px;">Watch it auto-design with proper AWS architecture!</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel">
            <h2>Feedback & Validation</h2>
            <div id="validation-results">
                <p style="color: #999; font-size: 13px; line-height: 1.6;">
                    <strong>üéØ Three Powerful Features:</strong><br><br>
                    <strong>1. Auto-Design:</strong> Type services, get intelligent layout<br>
                    <strong>2. Auto-Connect:</strong> Click to auto-generate data flow arrows<br>
                    <strong>3. Export to IaC:</strong> Generate Terraform/CloudFormation code<br><br>
                    Try: <code style="background: rgba(52,152,219,0.2); padding: 2px 6px;">region vpc igw alb 2 ec2 rds</code>
                </p>
            </div>
        </div>
    </div>

    <!-- Code Export Modal -->
    <div id="codeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="color: #ff9900;">üíª Export to Infrastructure as Code (IaC)</h2>
                <span class="modal-close" onclick="closeCodeModal()">&times;</span>
            </div>
            <div class="code-tabs">
                <div class="code-tab active" onclick="switchCodeTab('terraform')">Terraform (HCL)</div>
                <div class="code-tab" onclick="switchCodeTab('cloudformation')">CloudFormation (YAML)</div>
            </div>
            <div id="terraform-code" class="code-block">
                <pre id="terraform-content"></pre>
            </div>
            <div id="cloudformation-code" class="code-block" style="display: none;">
                <pre id="cloudformation-content"></pre>
            </div>
            <button class="btn btn-success" onclick="copyCode()">üìã Copy Code</button>
            <button class="btn btn-secondary" onclick="downloadCode()">üíæ Download File</button>
        </div>
    </div>

    <script>
        const serviceCategories = {
            'Infrastructure': [
                { name: 'Region', icon: 'üåé', type: 'infrastructure', container: true },
                { name: 'VPC', icon: 'üåê', type: 'networking', container: true },
                { name: 'Availability Zone', icon: 'üè¢', type: 'infrastructure', container: true },
                { name: 'Public Subnet', icon: 'üü¢', type: 'networking', container: true, subnetType: 'public' },
                { name: 'Private Subnet', icon: 'üî¥', type: 'networking', container: true, subnetType: 'private' }
            ],
            'Compute': [
                { name: 'EC2', icon: 'üñ•Ô∏è', type: 'compute' },
                { name: 'Auto Scaling Group', icon: 'üìä', type: 'compute' },
                { name: 'Lambda', icon: '‚ö°', type: 'compute' },
                { name: 'ECS', icon: 'üì¶', type: 'container' },
                { name: 'EKS', icon: '‚ò∏Ô∏è', type: 'container' }
            ],
            'Database': [
                { name: 'RDS', icon: 'üóÑÔ∏è', type: 'database' },
                { name: 'DynamoDB', icon: '‚ö°', type: 'database' },
                { name: 'ElastiCache', icon: '‚ö°', type: 'cache' },
                { name: 'Aurora', icon: 'üåü', type: 'database' }
            ],
            'Storage': [
                { name: 'S3', icon: 'ü™£', type: 'storage' },
                { name: 'EBS', icon: 'üíæ', type: 'storage' },
                { name: 'EFS', icon: 'üìÅ', type: 'storage' }
            ],
            'Networking': [
                { name: 'ALB', icon: 'üîÄ', type: 'networking' },
                { name: 'NLB', icon: '‚ö°', type: 'networking' },
                { name: 'NAT Gateway', icon: 'üö™', type: 'networking' },
                { name: 'Internet Gateway', icon: 'üåê', type: 'networking' },
                { name: 'API Gateway', icon: 'üîå', type: 'api' }
            ],
            'Security': [
                { name: 'Security Group', icon: 'üõ°Ô∏è', type: 'security' },
                { name: 'NACL', icon: 'üöß', type: 'security' },
                { name: 'WAF', icon: 'üõ°Ô∏è', type: 'security' },
                { name: 'IAM', icon: 'üîê', type: 'security' }
            ],
            'Management': [
                { name: 'CloudWatch', icon: 'üìä', type: 'monitoring' },
                { name: 'CloudTrail', icon: 'üë£', type: 'security' }
            ],
            'Global': [
                { name: 'CloudFront', icon: 'üåç', type: 'cdn' },
                { name: 'Route 53', icon: 'üó∫Ô∏è', type: 'dns' }
            ]
        };

        // AWS Architecture Best Practices Database (Offline Mode)
        const awsBestPractices = {
            requiredServices: {
                'web-app': ['VPC', 'ALB', 'EC2', 'RDS', 'Internet Gateway', 'Public Subnet', 'Private Subnet'],
                'serverless': ['API Gateway', 'Lambda', 'DynamoDB', 'IAM'],
                'microservices': ['EKS', 'ALB', 'RDS', 'VPC', 'Security Group'],
                'static-website': ['S3', 'CloudFront', 'Route 53']
            },
            
            securityRules: [
                { check: (elems) => elems.some(e => e.service.name === 'EC2' && !elems.some(x => x.service.name === 'Security Group')), 
                  msg: '‚ö†Ô∏è EC2 instances should have Security Groups', severity: 'high' },
                { check: (elems) => elems.some(e => e.service.name === 'RDS') && !elems.some(e => e.service.name === 'Private Subnet'),
                  msg: '‚ö†Ô∏è RDS should be in Private Subnet for security', severity: 'critical' },
                { check: (elems) => elems.some(e => e.service.name === 'ALB') && !elems.some(e => e.service.name === 'VPC'),
                  msg: '‚ö†Ô∏è ALB requires VPC', severity: 'critical' },
                { check: (elems) => elems.some(e => e.service.name === 'Internet Gateway') && !elems.some(e => e.service.name === 'VPC'),
                  msg: '‚ö†Ô∏è Internet Gateway requires VPC', severity: 'critical' }
            ],
            
            highAvailabilityRules: [
                { check: (elems) => !elems.some(e => e.service.name === 'Auto Scaling Group') && elems.filter(e => e.service.name === 'EC2').length === 1,
                  msg: 'üí° Consider Auto Scaling Group for High Availability', severity: 'medium' },
                { check: (elems) => elems.filter(e => e.service.subnetType === 'public').length === 1,
                  msg: 'üí° Use multiple Public Subnets in different AZs for HA', severity: 'medium' }
            ],
            
            costOptimizationRules: [
                { check: (elems) => elems.some(e => e.service.name === 'NAT Gateway') && !elems.some(e => e.service.name === 'Private Subnet'),
                  msg: 'üí° NAT Gateway costs ~$32/month - ensure you need it', severity: 'low' },
                { check: (elems) => elems.some(e => e.service.name === 'EC2') && !elems.some(e => e.service.name === 'Auto Scaling Group'),
                  msg: 'üí° Consider Spot Instances or ASG for cost savings', severity: 'low' }
            ]
        };

        let elements = [];
        let connections = [];
        let elementCounter = 0;
        let correctionCount = 0;
        let currentCodeTab = 'terraform';
        let currentMode = 'offline'; // 'offline' or 'online'

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('offline-btn').classList.toggle('active', mode === 'offline');
            document.getElementById('online-btn').classList.toggle('active', mode === 'online');
            
            if (mode === 'online') {
                const apiKey = prompt('Enter your Gemini API Key (AIza...):');
                if (apiKey && apiKey.startsWith('AIza')) {
                    localStorage.setItem('GEMINI_API_KEY', apiKey);
                    alert('‚úÖ API Key saved! Online mode activated.');
                } else {
                    alert('‚ùå Invalid key. Switching back to Offline mode.');
                    setMode('offline');
                }
            } else {
                localStorage.removeItem('GEMINI_API_KEY');
            }
        }

        function initServices() {
            const servicesList = document.getElementById('services-list');
            for (const [category, services] of Object.entries(serviceCategories)) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'service-category';
                const categoryTitle = document.createElement('div');
                categoryTitle.className = 'category-title';
                categoryTitle.textContent = category;
                categoryDiv.appendChild(categoryTitle);
                services.forEach(service => {
                    const serviceItem = document.createElement('div');
                    serviceItem.className = 'service-item';
                    serviceItem.draggable = true;
                    serviceItem.innerHTML = `
                        <span class="service-icon">${service.icon}</span>
                        <strong>${service.name}</strong>
                        ${service.container ? '<span class="info-badge">Container</span>' : ''}
                    `;
                    serviceItem.dataset.service = JSON.stringify(service);
                    serviceItem.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', e.target.dataset.service);
                    });
                    categoryDiv.appendChild(serviceItem);
                });
                servicesList.appendChild(categoryDiv);
            }
        }

        function setupCanvas() {
            const canvas = document.getElementById('canvas');
            canvas.addEventListener('dragover', (e) => e.preventDefault());
            canvas.addEventListener('drop', (e) => {
                e.preventDefault();
                const serviceData = e.dataTransfer.getData('text/plain');
                if (serviceData) {
                    const service = JSON.parse(serviceData);
                    const rect = canvas.getBoundingClientRect();
                    addElement(service, e.clientX - rect.left, e.clientY - rect.top);
                }
            });
        }

        function addElement(service, x, y, w, h) {
            elementCounter++;
            const id = `el-${elementCounter}`;
            
            const sizes = {
                'Region': { w: 1100, h: 650 },
                'VPC': { w: 950, h: 500 },
                'Availability Zone': { w: 400, h: 400 },
                'Public Subnet': { w: 420, h: 180 },
                'Private Subnet': { w: 420, h: 180 },
                'default': { w: 140, h: 90 }
            };
            
            const size = sizes[service.name] || sizes.default;
            const width = w || size.w;
            const height = h || size.h;
            
            let className = 'element-service';
            if (service.name === 'Region') className = 'element-region';
            else if (service.name === 'VPC') className = 'element-vpc';
            else if (service.subnetType === 'public') className = 'element-subnet-public';
            else if (service.subnetType === 'private') className = 'element-subnet-private';
            
            const el = document.createElement('div');
            el.className = `architecture-element ${className}`;
            el.id = id;
            el.style.left = `${x}px`;
            el.style.top = `${y}px`;
            el.style.width = `${width}px`;
            el.style.height = `${height}px`;
            
            let nameInput = '';
            if (service.name === 'Region') nameInput = '<input type="text" class="element-name-input" value="us-east-1" onclick="event.stopPropagation()">';
            else if (service.name === 'VPC') nameInput = '<input type="text" class="element-name-input" value="10.0.0.0/16" onclick="event.stopPropagation()">';
            
            el.innerHTML = `
                <div class="element-header">
                    <div class="element-title">
                        <span class="service-icon">${service.icon}</span>
                        <span>${service.name}</span>
                        ${nameInput}
                    </div>
                    <div class="element-controls">
                        <button class="element-btn expand-btn">‚Üî</button>
                        <button class="element-btn remove-btn">√ó</button>
                    </div>
                </div>
                <div class="element-content">${service.container ? '' : service.type}</div>
                <div class="resize-handle"></div>
            `;
            
            document.getElementById('canvas').appendChild(el);
            document.querySelector('.empty-state').style.display = 'none';
            
            el.querySelector('.expand-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                const currentW = parseInt(el.style.width);
                const currentH = parseInt(el.style.height);
                el.style.width = (currentW * 1.3) + 'px';
                el.style.height = (currentH * 1.3) + 'px';
            });
            
            el.querySelector('.remove-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                el.remove();
                elements = elements.filter(e => e.id !== id);
                connections = connections.filter(c => c.from !== id && c.to !== id);
                updateStats();
                redrawConnections();
                if (elements.length === 0) document.querySelector('.empty-state').style.display = 'block';
            });
            
            el.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('expand-btn') || e.target.classList.contains('remove-btn') || 
                    e.target.classList.contains('resize-handle') || e.target.classList.contains('element-name-input')) return;
                
                let startX = e.clientX - el.offsetLeft;
                let startY = e.clientY - el.offsetTop;
                
                function onMove(e) {
                    el.style.left = (e.clientX - startX) + 'px';
                    el.style.top = (e.clientY - startY) + 'px';
                    const item = elements.find(i => i.id === id);
                    if (item) {
                        item.x = parseInt(el.style.left);
                        item.y = parseInt(el.style.top);
                    }
                    redrawConnections();
                }
                
                function onUp() {
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onUp);
                }
                
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onUp);
            });
            
            const handle = el.querySelector('.resize-handle');
            handle.addEventListener('mousedown', (e) => {
                e.stopPropagation();
                const startX = e.clientX;
                const startY = e.clientY;
                const startW = el.offsetWidth;
                const startH = el.offsetHeight;
                
                function onMove(e) {
                    const newW = Math.max(100, startW + e.clientX - startX);
                    const newH = Math.max(80, startH + e.clientY - startY);
                    el.style.width = newW + 'px';
                    el.style.height = newH + 'px';
                }
                
                function onUp() {
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onUp);
                }
                
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onUp);
            });
            
            elements.push({ id, service, x, y, width, height });
            updateStats();
        }

        function setExample(text) {
            document.getElementById('smart-input').value = text;
        }

        function autoDesign() {
            const input = document.getElementById('smart-input').value.trim().toLowerCase();
            if (!input) return;
            correctionCount = 0;
            const corrections = [];
            const tokens = input.split(/[\s,]+/);
            const services = [];
            let i = 0;
            while (i < tokens.length) {
                const token = tokens[i];
                if (!isNaN(token)) {
                    const count = parseInt(token);
                    i++;
                    if (i < tokens.length) services.push({ name: tokens[i], count });
                } else {
                    services.push({ name: token, count: 1 });
                }
                i++;
            }
            const layout = buildIntelligentLayout(services, corrections);
            layout.forEach(item => {
                const service = findService(item.service);
                if (service) {
                    for (let j = 0; j < item.count; j++) {
                        const offset = j * 20;
                        addElement(service, item.x + offset, item.y + offset, item.w, item.h);
                    }
                }
            });
            if (corrections.length > 0) {
                correctionCount = corrections.length;
                alert('üß† Auto-Design Complete!\n\n‚úÖ ' + corrections.join('\n‚úÖ '));
            }
            document.getElementById('smart-input').value = '';
            updateStats();
            setTimeout(() => autoConnectServices(), 500);
        }

        function buildIntelligentLayout(services, corrections) {
            const layout = [];
            
            const baseX = 30;
            const baseY = 30;
            const regionW = 1100;
            const regionH = 650;
            const vpcW = 950;
            const vpcH = 500;
            const subnetW = 420;
            const subnetH = 180;
            
            const has = {
                region: services.some(s => s.name.includes('region')),
                vpc: services.some(s => s.name.includes('vpc')),
                igw: services.some(s => s.name.includes('igw') || s.name.includes('internet')),
                alb: services.some(s => s.name.includes('alb') || s.name.includes('loadbal')),
                nat: services.some(s => s.name.includes('nat')),
                ec2: services.some(s => s.name.includes('ec2')),
                rds: services.some(s => s.name.includes('rds') || s.name.includes('db')),
                eks: services.some(s => s.name.includes('eks') || s.name.includes('kubernetes') || s.name.includes('k8s')),
                ecs: services.some(s => s.name.includes('ecs')),
                lambda: services.some(s => s.name.includes('lambda')),
                public: services.filter(s => s.name.includes('public')),
                private: services.filter(s => s.name.includes('private'))
            };
            
            if (!has.region && (has.vpc || has.ec2 || has.rds || has.eks || has.ecs)) {
                has.region = true;
                corrections.push('Added Region (required)');
            }
            if (!has.vpc && (has.ec2 || has.rds || has.alb || has.eks || has.ecs)) {
                has.vpc = true;
                corrections.push('Added VPC (required)');
            }
            if ((has.alb || has.nat) && has.public.length === 0) {
                has.public = [{ name: 'public', count: 1 }];
                corrections.push('Added Public Subnet (ALB/NAT need public)');
            }
            if ((has.ec2 || has.rds || has.eks || has.ecs) && has.private.length === 0) {
                has.private = [{ name: 'private', count: 1 }];
                corrections.push('Added Private Subnet (EC2/RDS/EKS best practice)');
            }
            if (has.alb && !has.igw) {
                has.igw = true;
                corrections.push('Added IGW (required for internet)');
            }
            if (has.private.length > 0 && (has.ec2 || has.eks || has.ecs) && !has.nat) {
                has.nat = true;
                corrections.push('Added NAT (private needs internet)');
            }
            
            if (has.region) {
                layout.push({ service: 'region', x: baseX, y: baseY, w: regionW, h: regionH, count: 1 });
                
                if (has.igw) {
                    layout.push({ service: 'igw', x: baseX + (regionW/2) - 70, y: baseY + 20, w: 140, h: 70, count: 1 });
                }
                
                if (has.vpc) {
                    const vpcX = baseX + (regionW - vpcW)/2;
                    const vpcY = baseY + (has.igw ? 100 : 60);
                    layout.push({ service: 'vpc', x: vpcX, y: vpcY, w: vpcW, h: vpcH, count: 1 });
                    
                    let subnetX = vpcX + 40;
                    const subnetY = vpcY + 60;
                    
                    if (has.public.length > 0) {
                        const pubCount = has.public[0].count || 1;
                        for (let i = 0; i < pubCount; i++) {
                            layout.push({ service: 'public', x: subnetX, y: subnetY, w: subnetW, h: subnetH, count: 1 });
                            if (has.alb && i === 0) {
                                layout.push({ service: 'alb', x: subnetX + 150, y: subnetY + 50, w: 120, h: 70, count: 1 });
                            }
                            if (has.nat && i === 0) {
                                layout.push({ service: 'nat', x: subnetX + 30, y: subnetY + 40, w: 100, h: 60, count: 1 });
                            }
                            subnetX += subnetW + 40;
                        }
                    }
                    
                    if (has.private.length > 0) {
                        subnetX = vpcX + 40;
                        const privY = subnetY + subnetH + 50;
                        const privCount = has.private[0].count || 1;
                        
                        for (let i = 0; i < privCount; i++) {
                            layout.push({ service: 'private', x: subnetX, y: privY, w: subnetW, h: subnetH, count: 1 });
                            
                            let serviceX = subnetX + 30;
                            const serviceY = privY + 40;
                            
                            if (has.ec2 && i === 0) {
                                const ec2Count = services.find(s => s.name.includes('ec2'))?.count || 1;
                                layout.push({ service: 'ec2', x: serviceX, y: serviceY, w: 100, h: 60, count: ec2Count });
                                serviceX += 120;
                            }
                            
                            if (has.eks && i === 0) {
                                layout.push({ service: 'eks', x: serviceX, y: serviceY, w: 100, h: 60, count: 1 });
                                serviceX += 120;
                            }
                            
                            if (has.ecs && i === 0) {
                                layout.push({ service: 'ecs', x: serviceX, y: serviceY + 70, w: 100, h: 60, count: 1 });
                            }
                            
                            if (has.rds && i === 0) {
                                layout.push({ service: 'rds', x: subnetX + 280, y: privY + 50, w: 100, h: 70, count: 1 });
                            }
                            
                            subnetX += subnetW + 40;
                        }
                    }
                }
            }
            
            return layout;
        }

        function findService(name) {
            const map = {
                'region': 'Region',
                'vpc': 'VPC',
                'igw': 'Internet Gateway',
                'internet': 'Internet Gateway',
                'internetgateway': 'Internet Gateway',
                'alb': 'ALB',
                'nlb': 'NLB',
                'loadbalancer': 'ALB',
                'nat': 'NAT Gateway',
                'natgateway': 'NAT Gateway',
                'ec2': 'EC2',
                'instance': 'EC2',
                'rds': 'RDS',
                'db': 'RDS',
                'database': 'RDS',
                'dynamodb': 'DynamoDB',
                'dynamo': 'DynamoDB',
                'aurora': 'Aurora',
                'elasticache': 'ElastiCache',
                'cache': 'ElastiCache',
                'redis': 'ElastiCache',
                's3': 'S3',
                'bucket': 'S3',
                'ebs': 'EBS',
                'efs': 'EFS',
                'lambda': 'Lambda',
                'ecs': 'ECS',
                'eks': 'EKS',
                'kubernetes': 'EKS',
                'k8s': 'EKS',
                'asg': 'Auto Scaling Group',
                'autoscaling': 'Auto Scaling Group',
                'autoscalinggroup': 'Auto Scaling Group',
                'public': 'Public Subnet',
                'publicsubnet': 'Public Subnet',
                'private': 'Private Subnet',
                'privatesubnet': 'Private Subnet',
                'subnet': 'Public Subnet',
                'az': 'Availability Zone',
                'availabilityzone': 'Availability Zone',
                'sg': 'Security Group',
                'securitygroup': 'Security Group',
                'security': 'Security Group',
                'nacl': 'NACL',
                'waf': 'WAF',
                'firewall': 'WAF',
                'iam': 'IAM',
                'apigateway': 'API Gateway',
                'api': 'API Gateway',
                'cloudwatch': 'CloudWatch',
                'monitoring': 'CloudWatch',
                'cloudtrail': 'CloudTrail',
                'cloudfront': 'CloudFront',
                'cdn': 'CloudFront',
                'route53': 'Route 53',
                'dns': 'Route 53'
            };
            
            const serviceName = map[name.toLowerCase()] || name;
            
            for (const services of Object.values(serviceCategories)) {
                const found = services.find(s => s.name.toLowerCase() === serviceName.toLowerCase());
                if (found) return found;
            }
            
            return null;
        }

        function autoConnectServices() {
            connections = [];
            const igw = elements.find(e => e.service.name === 'Internet Gateway');
            const alb = elements.find(e => e.service.name === 'ALB');
            const nat = elements.find(e => e.service.name === 'NAT Gateway');
            const ec2List = elements.filter(e => e.service.name === 'EC2');
            const rds = elements.find(e => e.service.name === 'RDS');
            
            if (igw && alb) {
                connections.push({ 
                    from: igw.id, 
                    to: alb.id, 
                    color: '#2ecc71',
                    width: 3,
                    label: '‚ë† Inbound'
                });
            }
            
            if (alb && ec2List.length > 0) {
                ec2List.forEach((ec2, idx) => {
                    connections.push({ 
                        from: alb.id, 
                        to: ec2.id, 
                        color: '#3498db',
                        width: 2,
                        label: '‚ë° Load Balance'
                    });
                });
            }
            
            if (ec2List.length > 0 && rds) {
                connections.push({ 
                    from: ec2List[0].id, 
                    to: rds.id, 
                    color: '#9b59b6',
                    width: 2,
                    label: '‚ë¢ Database'
                });
            }
            
            if (nat && ec2List.length > 0) {
                connections.push({ 
                    from: ec2List[0].id, 
                    to: nat.id, 
                    color: '#e67e22',
                    width: 2,
                    label: '‚ë£ Updates'
                });
            }
            
            if (nat && igw) {
                connections.push({ 
                    from: nat.id, 
                    to: igw.id, 
                    color: '#e74c3c',
                    width: 2,
                    label: '‚ë§ Exit'
                });
            }
            
            redrawConnections();
            updateStats();
            
            alert(`‚úÖ Connected ${connections.length} intelligent data flows!\n\n` +
                  `üü¢ Inbound: Internet ‚Üí IGW ‚Üí ALB ‚Üí EC2\n` +
                  `üü£ Data: EC2 ‚Üî RDS (database queries)\n` +
                  `üü† Outbound: EC2 ‚Üí NAT ‚Üí IGW (updates)`);
        }

        function redrawConnections() {
            const svg = document.getElementById('connections-svg');
            svg.querySelectorAll('path, text').forEach(el => el.remove());
            
            connections.forEach(conn => {
                const fromEl = document.getElementById(conn.from);
                const toEl = document.getElementById(conn.to);
                if (!fromEl || !toEl) return;
                
                const canvasRect = document.getElementById('canvas').getBoundingClientRect();
                const fromRect = fromEl.getBoundingClientRect();
                const toRect = toEl.getBoundingClientRect();
                
                const x1 = fromRect.left + fromRect.width / 2 - canvasRect.left;
                const y1 = fromRect.top + fromRect.height - canvasRect.top;
                const x2 = toRect.left + toRect.width / 2 - canvasRect.left;
                const y2 = toRect.top - canvasRect.top;
                
                const midY = (y1 + y2) / 2;
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                
                const d = `M ${x1} ${y1} Q ${x1} ${midY}, ${(x1 + x2) / 2} ${midY} T ${x2} ${y2}`;
                
                path.setAttribute('d', d);
                path.setAttribute('fill', 'none');
                path.setAttribute('stroke', conn.color || '#3498db');
                path.setAttribute('stroke-width', conn.width || 2);
                path.setAttribute('marker-end', 'url(#arrowhead-' + (conn.color || 'blue').replace('#', '') + ')');
                path.setAttribute('opacity', '0.9');
                
                svg.appendChild(path);
                
                if (conn.label) {
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', (x1 + x2) / 2);
                    text.setAttribute('y', midY - 5);
                    text.setAttribute('fill', conn.color || '#3498db');
                    text.setAttribute('font-size', '11px');
                    text.setAttribute('font-weight', 'bold');
                    text.setAttribute('text-anchor', 'middle');
                    text.textContent = conn.label;
                    svg.appendChild(text);
                }
            });
        }

        function exportToCode() {
            if (elements.length === 0) {
                alert('Add services first!');
                return;
            }
            generateTerraformCode();
            generateCloudFormationCode();
            document.getElementById('codeModal').style.display = 'block';
        }

        function generateTerraformCode() {
            let code = `# Generated by AWS Architecture Design Studio
# Architecture: ${elements.length} services

terraform {
  required_version = ">= 1.0"
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}

provider "aws" {
  region = "us-east-1"
}

`;
            const vpc = elements.find(e => e.service.name === 'VPC');
            if (vpc) {
                const cidr = vpc.service.name === 'VPC' ? '10.0.0.0/16' : '10.0.0.0/16';
                code += `resource "aws_vpc" "main" {
  cidr_block           = "${cidr}"
  enable_dns_hostnames = true
  enable_dns_support   = true

  tags = {
    Name = "main-vpc"
  }
}

`;
            }
            const igw = elements.find(e => e.service.name === 'Internet Gateway');
            if (igw && vpc) {
                code += `resource "aws_internet_gateway" "main" {
  vpc_id = aws_vpc.main.id

  tags = {
    Name = "main-igw"
  }
}

`;
            }
            const pubSubnets = elements.filter(e => e.service.subnetType === 'public');
            pubSubnets.forEach((subnet, i) => {
                code += `resource "aws_subnet" "public_${i+1}" {
  vpc_id                  = aws_vpc.main.id
  cidr_block              = "10.0.${i+1}.0/24"
  availability_zone       = data.aws_availability_zones.available.names[${i}]
  map_public_ip_on_launch = true

  tags = {
    Name = "public-subnet-${i+1}"
  }
}

`;
            });
            const privSubnets = elements.filter(e => e.service.subnetType === 'private');
            privSubnets.forEach((subnet, i) => {
                code += `resource "aws_subnet" "private_${i+1}" {
  vpc_id            = aws_vpc.main.id
  cidr_block        = "10.0.${10+i}.0/24"
  availability_zone = data.aws_availability_zones.available.names[${i}]

  tags = {
    Name = "private-subnet-${i+1}"
  }
}

`;
            });
            const nat = elements.find(e => e.service.name === 'NAT Gateway');
            if (nat && pubSubnets.length > 0) {
                code += `resource "aws_eip" "nat" {
  domain = "vpc"
}

resource "aws_nat_gateway" "main" {
  allocation_id = aws_eip.nat.id
  subnet_id     = aws_subnet.public_1.id

  tags = {
    Name = "main-nat-gateway"
  }
}

`;
            }
            const alb = elements.find(e => e.service.name === 'ALB');
            if (alb) {
                code += `resource "aws_lb" "main" {
  name               = "main-alb"
  internal           = false
  load_balancer_type = "application"
  security_groups    = [aws_security_group.alb.id]
  subnets            = [aws_subnet.public_1.id, aws_subnet.public_2.id]

  tags = {
    Name = "main-alb"
  }
}

resource "aws_security_group" "alb" {
  name        = "alb-sg"
  description = "Security group for ALB"
  vpc_id      = aws_vpc.main.id

  ingress {
    from_port   = 80
    to_port     = 80
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  ingress {
    from_port   = 443
    to_port     = 443
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }
}

`;
            }
            const ec2List = elements.filter(e => e.service.name === 'EC2');
            if (ec2List.length > 0) {
                code += `resource "aws_instance" "app" {
  count         = ${ec2List.length}
  ami           = data.aws_ami.amazon_linux.id
  instance_type = "t3.micro"
  subnet_id     = aws_subnet.private_1.id
  vpc_security_group_ids = [aws_security_group.ec2.id]

  tags = {
    Name = "app-server-\${count.index + 1}"
  }
}

resource "aws_security_group" "ec2" {
  name        = "ec2-sg"
  description = "Security group for EC2"
  vpc_id      = aws_vpc.main.id

  ingress {
    from_port       = 80
    to_port         = 80
    protocol        = "tcp"
    security_groups = [aws_security_group.alb.id]
  }

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }
}

data "aws_ami" "amazon_linux" {
  most_recent = true
  owners      = ["amazon"]

  filter {
    name   = "name"
    values = ["amzn2-ami-hvm-*-x86_64-gp2"]
  }
}

`;
            }
            const rds = elements.find(e => e.service.name === 'RDS');
            if (rds && privSubnets.length > 0) {
                code += `resource "aws_db_instance" "main" {
  identifier           = "main-db"
  engine              = "postgres"
  engine_version      = "15.3"
  instance_class      = "db.t3.micro"
  allocated_storage   = 20
  db_name             = "myapp"
  username            = "admin"
  password            = "changeme123!"  # Use AWS Secrets Manager in production
  skip_final_snapshot = true
  vpc_security_group_ids = [aws_security_group.rds.id]
  db_subnet_group_name   = aws_db_subnet_group.main.name

  tags = {
    Name = "main-database"
  }
}

resource "aws_db_subnet_group" "main" {
  name       = "main-db-subnet-group"
  subnet_ids = [aws_subnet.private_1.id, aws_subnet.private_2.id]
}

resource "aws_security_group" "rds" {
  name        = "rds-sg"
  description = "Security group for RDS"
  vpc_id      = aws_vpc.main.id

  ingress {
    from_port       = 5432
    to_port         = 5432
    protocol        = "tcp"
    security_groups = [aws_security_group.ec2.id]
  }

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }
}

`;
            }
            code += `data "aws_availability_zones" "available" {
  state = "available"
}

output "vpc_id" {
  value = aws_vpc.main.id
}
`;
            if (alb) {
                code += `
output "alb_dns" {
  value = aws_lb.main.dns_name
}
`;
            }
            document.getElementById('terraform-content').textContent = code;
        }

        function generateCloudFormationCode() {
            let code = `# Generated by AWS Architecture Design Studio
# Architecture: ${elements.length} services

AWSTemplateFormatVersion: '2010-09-09'
Description: 'Auto-generated AWS Architecture'

Resources:
`;
            const vpc = elements.find(e => e.service.name === 'VPC');
            if (vpc) {
                code += `  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: main-vpc

`;
            }
            const igw = elements.find(e => e.service.name === 'Internet Gateway');
            if (igw && vpc) {
                code += `  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: main-igw

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

`;
            }
            const pubSubnets = elements.filter(e => e.service.subnetType === 'public');
            pubSubnets.forEach((subnet, i) => {
                code += `  PublicSubnet${i+1}:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.${i+1}.0/24
      AvailabilityZone: !Select [${i}, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: public-subnet-${i+1}

`;
            });
            const alb = elements.find(e => e.service.name === 'ALB');
            if (alb) {
                code += `  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: main-alb
      Subnets:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
      SecurityGroups:
        - !Ref ALBSecurityGroup
      Tags:
        - Key: Name
          Value: main-alb

  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for ALB
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0

`;
            }
            const ec2List = elements.filter(e => e.service.name === 'EC2');
            if (ec2List.length > 0) {
                code += `  EC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Ref LatestAmiId
      InstanceType: t3.micro
      SubnetId: !Ref PrivateSubnet1
      SecurityGroupIds:
        - !Ref EC2SecurityGroup
      Tags:
        - Key: Name
          Value: app-server

  EC2SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for EC2
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref ALBSecurityGroup

`;
            }
            code += `
Parameters:
  LatestAmiId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2

Outputs:
  VPCId:
    Description: VPC ID
    Value: !Ref VPC
`;
            if (alb) {
                code += `  ALBDNSName:
    Description: ALB DNS Name
    Value: !GetAtt ApplicationLoadBalancer.DNSName
`;
            }
            document.getElementById('cloudformation-content').textContent = code;
        }

        function switchCodeTab(tab) {
            currentCodeTab = tab;
            document.querySelectorAll('.code-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[onclick="switchCodeTab('${tab}')"]`).classList.add('active');
            document.getElementById('terraform-code').style.display = tab === 'terraform' ? 'block' : 'none';
            document.getElementById('cloudformation-code').style.display = tab === 'cloudformation' ? 'block' : 'none';
        }

        function closeCodeModal() {
            document.getElementById('codeModal').style.display = 'none';
        }

        function copyCode() {
            const content = currentCodeTab === 'terraform' ? 
                document.getElementById('terraform-content').textContent :
                document.getElementById('cloudformation-content').textContent;
            navigator.clipboard.writeText(content);
            alert('‚úÖ Code copied to clipboard!');
        }

        function downloadCode() {
            const content = currentCodeTab === 'terraform' ? 
                document.getElementById('terraform-content').textContent :
                document.getElementById('cloudformation-content').textContent;
            const filename = currentCodeTab === 'terraform' ? 'main.tf' : 'template.yaml';
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            alert(`‚úÖ Downloaded ${filename}!`);
        }

        function updateStats() {
            document.getElementById('element-count').textContent = elements.length;
            document.getElementById('connection-count').textContent = connections.length;
            document.getElementById('correction-count').textContent = correctionCount;
        }

        function clearArchitecture() {
            elements = [];
            connections = [];
            correctionCount = 0;
            
            const canvas = document.getElementById('canvas');
            canvas.innerHTML = `
                <svg id="connections-svg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;">
                    <defs>
                        <marker id="arrowhead-green" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                            <polygon points="0 0, 10 3, 0 6" fill="#2ecc71" />
                        </marker>
                        <marker id="arrowhead-blue" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                            <polygon points="0 0, 10 3, 0 6" fill="#3498db" />
                        </marker>
                        <marker id="arrowhead-purple" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                            <polygon points="0 0, 10 3, 0 6" fill="#9b59b6" />
                        </marker>
                        <marker id="arrowhead-orange" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                            <polygon points="0 0, 10 3, 0 6" fill="#e67e22" />
                        </marker>
                        <marker id="arrowhead-red" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                            <polygon points="0 0, 10 3, 0 6" fill="#e74c3c" />
                        </marker>
                    </defs>
                </svg>
                <div class="empty-state">
                    <h3>üß† Intelligent Auto-Design</h3>
                    <p>Type: <strong>region vpc igw alb 2 ec2 rds</strong></p>
                    <p style="margin-top: 8px; font-size: 12px;">Watch it auto-design with proper AWS architecture!</p>
                </div>
            `;
            
            document.getElementById('validation-results').innerHTML = '';
            updateStats();
        }

        // Offline Smart Validation
        function runOfflineValidation() {
            const issues = [];
            const suggestions = [];
            let score = 10;
            
            // Security Checks
            awsBestPractices.securityRules.forEach(rule => {
                if (rule.check(elements)) {
                    issues.push({ msg: rule.msg, severity: rule.severity });
                    if (rule.severity === 'critical') score -= 2;
                    else if (rule.severity === 'high') score -= 1;
                }
            });
            
            // High Availability Checks
            awsBestPractices.highAvailabilityRules.forEach(rule => {
                if (rule.check(elements)) {
                    suggestions.push(rule.msg);
                    score -= 0.5;
                }
            });
            
            // Cost Checks
            awsBestPractices.costOptimizationRules.forEach(rule => {
                if (rule.check(elements)) {
                    suggestions.push(rule.msg);
                }
            });
            
            // Specific architecture detection
            const hasWebApp = elements.some(e => e.service.name === 'EC2') && 
                              elements.some(e => e.service.name === 'ALB') &&
                              elements.some(e => e.service.name === 'RDS');
            
            const hasServerless = elements.some(e => e.service.name === 'Lambda');
            
            let architecture = 'Generic';
            if (hasWebApp) architecture = '3-Tier Web Application';
            else if (hasServerless) architecture = 'Serverless Architecture';
            
            return {
                rating: score >= 8 ? '‚úÖ Production Ready' : (score >= 5 ? '‚ö†Ô∏è Needs Work' : '‚ùå Major Issues'),
                score: Math.max(0, Math.round(score)),
                architecture,
                issues,
                suggestions,
                desc: `Detected: ${architecture}\nServices: ${elements.map(e => e.service.name).join(', ')}`
            };
        }

        async function validateArchitecture() {
            if (elements.length === 0) {
                alert('Add services first!');
                return;
            }
            
            const results = document.getElementById('validation-results');
            results.innerHTML = '<div class="loading"><div class="spinner"></div><p>Analyzing architecture...</p></div>';
            
            if (currentMode === 'offline') {
                setTimeout(() => {
                    const validation = runOfflineValidation();
                    
                    let html = `
                        <div class="validation-result">
                            <h3 style="color: #2ecc71; margin-top: 0;">${validation.rating}</h3>
                            <p><strong>üèóÔ∏è Architecture Type:</strong> ${validation.architecture}</p>
                            <p><strong>üìä Best Practices Score:</strong> ${validation.score}/10</p>
                    `;
                    
                    if (validation.issues.length > 0) {
                        html += `<h4 style="color: #e74c3c; margin-top: 15px;">üö® Critical Issues:</h4><ul>`;
                        validation.issues.forEach(issue => {
                            html += `<li style="margin-bottom: 5px;">${issue.msg}</li>`;
                        });
                        html += '</ul>';
                    }
                    
                    if (validation.suggestions.length > 0) {
                        html += `<h4 style="color: #f39c12; margin-top: 15px;">üí° Recommendations:</h4><ul>`;
                        validation.suggestions.forEach(sugg => {
                            html += `<li style="margin-bottom: 5px;">${sugg}</li>`;
                        });
                        html += '</ul>';
                    }
                    
                    if (validation.issues.length === 0 && validation.suggestions.length === 0) {
                        html += `<p style="color: #2ecc71; margin-top: 15px;">‚úÖ Excellent! Your architecture follows AWS best practices.</p>`;
                    }
                    
                    html += `
                            <p style="margin-top: 20px; font-size: 12px; color: #7f8c8d; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;">
                                üß† Powered by Offline Smart Engine (No API required)
                            </p>
                        </div>
                    `;
                    
                    results.innerHTML = html;
                }, 800);
            } else {
                // Online mode with API
                const apiKey = localStorage.getItem('GEMINI_API_KEY');
                if (!apiKey) {
                    alert('Please set API key first or switch to Offline mode');
                    setMode('offline');
                    return;
                }
                
                const desc = elements.map(e => e.service.name).join(', ');
                
                try {
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [{
                                        text: `You are an AWS Solutions Architect expert. Validate this AWS architecture: ${desc}

Provide:
1) Overall Rating: [Production Ready / Needs Work / Major Issues]
2) Critical Issues: List missing services or security gaps
3) Specific Fixes: Exactly what to add/change
4) Best Practices Score: X/10

Be concise and actionable. Use bullet points.`
                                    }]
                                }],
                                generationConfig: {
                                    temperature: 0.7,
                                    maxOutputTokens: 1000
                                }
                            })
                        }
                    );
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        // Fallback to offline if API fails
                        results.innerHTML = `<div class="validation-result" style="background: rgba(231, 76, 60, 0.1);">
                            <p style="color: #e74c3c;">API Error: ${data.error.message}</p>
                            <p style="font-size: 12px; margin-top: 10px;">Switching to Offline Mode...</p>
                        </div>`;
                        setTimeout(() => {
                            setMode('offline');
                            validateArchitecture();
                        }, 1500);
                        return;
                    }
                    
                    const feedback = data.candidates[0].content.parts[0].text;
                    results.innerHTML = `<div class="validation-result">
                        <h3 style="color: #2ecc71; margin-top: 0;">‚úÖ AI Validation Results</h3>
                        ${feedback.replace(/\n/g, '<br>')}
                        <p style="margin-top: 20px; font-size: 12px; color: #7f8c8d;">
                            Powered by Google Gemini Pro
                        </p>
                    </div>`;
                    
                } catch (error) {
                    results.innerHTML = `<div class="validation-result" style="background: rgba(231, 76, 60, 0.1);">
                        <p style="color: #e74c3c;">Network Error. Using Offline Mode...</p>
                    </div>`;
                    setTimeout(() => {
                        setMode('offline');
                        validateArchitecture();
                    }, 1000);
                }
            }
        }

        function generateFullDesign() {
            const results = document.getElementById('validation-results');
            
            if (currentMode === 'offline') {
                results.innerHTML = `
                    <div class="validation-result">
                        <h3 style="color: #2ecc71; margin-top: 0;">üèóÔ∏è Recommended Production Architecture</h3>
                        
                        <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 6px; margin: 10px 0;">
                            <p><strong>Type this command:</strong></p>
                            <code style="background: rgba(52,152,219,0.2); padding: 8px; display: block; margin: 10px 0; border-radius: 4px; font-family: monospace;">
                                region vpc 2 az igw nat alb asg ec2 rds s3 cloudwatch
                            </code>
                            <button onclick="setExample('region vpc 2 az igw nat alb asg ec2 rds s3 cloudwatch'); autoDesign();" 
                                    style="background: #2ecc71; border: none; color: white; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold;">
                                üöÄ Auto-Build This Architecture
                            </button>
                        </div>
                        
                        <h4>üè¢ Architecture Components:</h4>
                        <ul style="line-height: 1.8;">
                            <li><strong>Multi-AZ Deployment</strong> - High Availability across 2 Availability Zones</li>
                            <li><strong>Public Subnets</strong> - ALB and NAT Gateways for internet access</li>
                            <li><strong>Private Subnets</strong> - EC2 instances and RDS for security</li>
                            <li><strong>Auto Scaling</strong> - Automatic scaling based on demand</li>
                            <li><strong>Load Balancing</strong> - Application Load Balancer for traffic distribution</li>
                            <li><strong>Database</strong> - RDS Multi-AZ for data redundancy</li>
                            <li><strong>Storage</strong> - S3 for static assets and backups</li>
                            <li><strong>Monitoring</strong> - CloudWatch for logs and metrics</li>
                        </ul>
                        
                        <h4 style="margin-top: 15px;">üîê Security Features:</h4>
                        <ul style="line-height: 1.8;">
                            <li>Defense in depth with Security Groups and NACLs</li>
                            <li>No direct internet access to database</li>
                            <li>NAT Gateway for secure outbound connections</li>
                            <li>Private subnet isolation for sensitive components</li>
                        </ul>
                        
                        <p style="margin-top: 20px; font-size: 12px; color: #7f8c8d;">
                            üß† Generated by Offline Smart Engine
                        </p>
                    </div>
                `;
            } else {
                // Try online mode
                validateArchitecture(); // This will use the API if available
            }
        }

        // Global functions
        window.autoDesign = autoDesign;
        window.setExample = setExample;
        window.clearArchitecture = clearArchitecture;
        window.validateArchitecture = validateArchitecture;
        window.generateFullDesign = generateFullDesign;
        window.autoConnectServices = autoConnectServices;
        window.exportToCode = exportToCode;
        window.switchCodeTab = switchCodeTab;
        window.closeCodeModal = closeCodeModal;
        window.copyCode = copyCode;
        window.downloadCode = downloadCode;
        window.setMode = setMode;

        // Initialize
        initServices();
        setupCanvas();
        updateStats();
        
        // Auto-set to offline mode on load (since API has issues)
        setMode('offline');
    </script>
</body>
</html>