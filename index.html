<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>AWS Architecture Design Studio (Rewritten + Fixed)</title>

<style>
/* ===========================
   GLOBAL STYLES
=========================== */
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: Arial, Helvetica, sans-serif;
  background: #1a242f;
  color: #fff;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

h1, h2 {
  color: #ff9900;
  margin: 0 0 8px 0;
}

button {
  border: none;
  border-radius: 6px;
  padding: 8px 14px;
  font-weight: bold;
  cursor: pointer;
}

.btn-primary { background: #ff9900; color: #232f3e; }
.btn-success { background: #2ecc71; color: #fff; }
.btn-secondary { background: #3498db; color: #fff; }
.btn-danger { background: #e74c3c; color: #fff; }

input {
  width: 100%;
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #555;
  background: #111;
  color: #fff;
}

/* ===========================
   HEADER
=========================== */
header {
  padding: 14px 18px;
  background: #232f3e;
  border-bottom: 3px solid #ff9900;
}

header p {
  margin: 4px 0 0 0;
  color: #3498db;
  font-size: 13px;
}

/* ===========================
   LAYOUT
=========================== */
.main {
  flex: 1;
  display: grid;
  grid-template-columns: 260px 1fr 380px;
  gap: 12px;
  padding: 12px;
}

.panel {
  background: rgba(255,255,255,0.06);
  border-radius: 8px;
  padding: 12px;
  overflow: auto;
}

/* ===========================
   LEFT: SERVICES
=========================== */
.service {
  background: rgba(255,153,0,0.15);
  border: 1px solid #ff9900;
  border-radius: 6px;
  padding: 8px;
  margin-bottom: 8px;
  cursor: grab;
  font-size: 13px;
}

/* ===========================
   CANVAS
=========================== */
.workspace {
  display: flex;
  flex-direction: column;
}

.toolbar {
  display: flex;
  gap: 8px;
  margin-bottom: 8px;
}

#canvas {
  position: relative;
  flex: 1;
  min-height: 700px;
  background:
    linear-gradient(rgba(52,152,219,0.12) 1px, transparent 1px),
    linear-gradient(90deg, rgba(52,152,219,0.12) 1px, transparent 1px);
  background-size: 40px 40px;
  border-radius: 8px;
}

.node {
  position: absolute;
  padding: 10px;
  border-radius: 8px;
  background: rgba(255,153,0,0.2);
  border: 2px solid #ff9900;
  cursor: move;
  font-size: 12px;
}

/* ===========================
   RIGHT: AI PANEL
=========================== */
.result {
  background: rgba(46,204,113,0.12);
  border-left: 4px solid #2ecc71;
  border-radius: 6px;
  padding: 10px;
  font-size: 13px;
  line-height: 1.5;
}

.error {
  background: #e74c3c;
  border-left: 4px solid #c0392b;
  padding: 10px;
  border-radius: 6px;
}

.spinner {
  width: 36px;
  height: 36px;
  border: 3px solid rgba(255,255,255,0.3);
  border-top: 3px solid #ff9900;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 10px auto;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>
</head>

<body>

<header>
  <h1>üèóÔ∏è AWS Architecture Design Studio</h1>
  <p>Rewritten ‚Ä¢ Fixed Gemini API ‚Ä¢ One-file tool</p>
</header>

<div class="main">

  <!-- LEFT -->
  <div class="panel">
    <h2>AWS Services</h2>
    <div class="service" draggable="true" data-name="Region">üåç Region</div>
    <div class="service" draggable="true" data-name="VPC">üåê VPC</div>
    <div class="service" draggable="true" data-name="ALB">üîÄ ALB</div>
    <div class="service" draggable="true" data-name="EC2">üñ•Ô∏è EC2</div>
    <div class="service" draggable="true" data-name="RDS">üóÑÔ∏è RDS</div>
    <div class="service" draggable="true" data-name="NAT Gateway">üö™ NAT Gateway</div>
  </div>

  <!-- CENTER -->
  <div class="panel workspace">
    <div class="toolbar">
      <button class="btn-success" onclick="generateAI()">ü§ñ Generate</button>
      <button class="btn-primary" onclick="validateAI()">‚úì Validate</button>
      <button class="btn-danger" onclick="clearCanvas()">üóëÔ∏è Clear</button>
    </div>
    <div id="canvas"></div>
  </div>

  <!-- RIGHT -->
  <div class="panel">
    <h2>AI Feedback</h2>

    <input id="apiKey" placeholder="Gemini API Key (AIza...)" />
    <button class="btn-primary" style="margin:8px 0" onclick="saveKey()">Save Key</button>

    <div id="output">
      <p style="color:#aaa;font-size:13px">
        Add services ‚Üí Validate or Generate using Gemini AI
      </p>
    </div>
  </div>

</div>

<script>
/* ======================================================
   BASIC CANVAS LOGIC
====================================================== */
const canvas = document.getElementById("canvas");
let nodes = [];

document.querySelectorAll(".service").forEach(s => {
  s.addEventListener("dragstart", e => {
    e.dataTransfer.setData("text/plain", s.dataset.name);
  });
});

canvas.addEventListener("dragover", e => e.preventDefault());

canvas.addEventListener("drop", e => {
  e.preventDefault();
  const name = e.dataTransfer.getData("text/plain");
  addNode(name, e.offsetX, e.offsetY);
});

function addNode(name, x, y) {
  const el = document.createElement("div");
  el.className = "node";
  el.textContent = name;
  el.style.left = x + "px";
  el.style.top = y + "px";
  makeDraggable(el);
  canvas.appendChild(el);
  nodes.push(name);
}

function makeDraggable(el) {
  el.onmousedown = e => {
    const ox = e.offsetX;
    const oy = e.offsetY;
    document.onmousemove = ev => {
      el.style.left = ev.pageX - canvas.offsetLeft - ox + "px";
      el.style.top = ev.pageY - canvas.offsetTop - oy + "px";
    };
    document.onmouseup = () => document.onmousemove = null;
  };
}

function clearCanvas() {
  canvas.innerHTML = "";
  nodes = [];
}

/* ======================================================
   GEMINI API (FIXED)
====================================================== */
const GEMINI_ENDPOINT =
  "https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent";

function saveKey() {
  const k = document.getElementById("apiKey").value.trim();
  if (!k.startsWith("AIza")) {
    alert("Invalid Gemini API key");
    return;
  }
  localStorage.setItem("GEMINI_API_KEY", k);
  alert("API key saved");
}

async function callGemini(prompt) {
  const key = localStorage.getItem("GEMINI_API_KEY");
  if (!key) throw new Error("API key missing");

  const res = await fetch(GEMINI_ENDPOINT + "?key=" + key, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      contents: [{ parts: [{ text: prompt }] }]
    })
  });

  const data = await res.json();
  if (data.error) throw new Error(data.error.message);
  return data.candidates[0].content.parts[0].text;
}

/* ======================================================
   AI ACTIONS
====================================================== */
async function validateAI() {
  const out = document.getElementById("output");
  if (nodes.length === 0) return alert("Add services first");

  out.innerHTML = '<div class="spinner"></div>';

  try {
    const text = await callGemini(
      "Validate this AWS architecture: " + nodes.join(", ")
    );
    out.innerHTML = '<div class="result">' + text.replace(/\n/g,"<br>") + '</div>';
  } catch (e) {
    out.innerHTML = '<div class="error">' + e.message + '</div>';
  }
}

async function generateAI() {
  const out = document.getElementById("output");
  out.innerHTML = '<div class="spinner"></div>';

  try {
    const text = await callGemini(
      "Design a production-ready AWS architecture and list services"
    );
    out.innerHTML = '<div class="result">' + text.replace(/\n/g,"<br>") + '</div>';
  } catch (e) {
    out.innerHTML = '<div class="error">' + e.message + '</div>';
  }
}
</script>

</body>
</html>
